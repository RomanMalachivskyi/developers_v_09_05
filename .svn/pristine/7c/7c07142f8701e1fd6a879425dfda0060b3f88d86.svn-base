$(function() {



var unitCanvas = document.getElementById("unit_canvas");

var ctx = unitCanvas.getContext("2d");   
var HEIGHT =50;
var WEIGTH = 50;

var mapUnits = new Array();

var initCanvas = function(){
   unitCanvas.height = 750;
   unitCanvas.width = 1000;
};

var draw = function(path,x,y, angle){
    var img = new Image();
    img.src = path;
    
    $(img).load(function(){
       rotate(angle, img, x, y); 

    });
    
};

var drawUnitList = function(){
  //alert("here");
  for(var i=0;i<mapUnits.length;i++){
        draw(mapUnits[i].textures[0],mapUnits[i].x,mapUnits[i].y,mapUnits[i].angle);  
        
   }
};



var rotate = function(angle, img, x, y){
    angle = angle*1;
    
    x = x * 1;                        
    y = y * 1;
    
    ctx.save();
    ctx.translate(x+WEIGTH/2,y+HEIGHT/2);       
    
    ctx.rotate(angle * Math.PI / 180);
    ctx.drawImage(img, -(WEIGTH/2), -(HEIGHT/2));
    ctx.restore();  
};




var getUnits = function(){
    
    initCanvas();
    $.ajax({
            url : "get_unit",
            contentType : "application/x-www-form-urlencoded",
            data : {
                "message" : "give_me_units"
            },
            success : function(teams) {
              
               for(var z =0; z<teams.length; z++){
                   
                var team = teams[z];
                var units = team.units;
                    for(var i=0;i<units.length;i++){
                    var	unit ={};
                    unit = {
                    	    "id" : units[i].id,
                    	    "x"  : units[i].x - 25,
                    	    "y"  : units[i].y - 25,
                            "angle" : units[i].rotationAngle,
                            "textures" :  [ units[i].textures[0], units[i].textures[1], units[i].textures[2], units[i].textures[3], units[i].textures[4]]                    	    
                    };
                    mapUnits.push(unit);
                    //draw(mapUnits[i].textures[0],mapUnits[i].x,mapUnits[i].y,mapUnits[i].angle);  
                    }
                    
               }
             drawUnitList();  
              
            },
            error : function(error) {
                alert(error.responseText);
            }
        });
        
    
};

var getMovingUnits = function(){
    
    $.ajax({
            url : "get_moving_unit",
            contentType : "application/x-www-form-urlencoded",
            data : {
                "message" : "give_me_moving_units"
            },
            success : function(units) {
             
             for(var i=0;i<units.length;i++){
                  for(var j = 0; j<mapUnits.length;j++)
                    if(units[i].id == mapUnits[j].id){
                        ctx.clearRect( mapUnits[j].x, mapUnits[j].y,WEIGTH, HEIGHT);
                        mapUnits[j].x = units[i].x - 25;
                        mapUnits[j].y = units[i].y - 25;
                        mapUnits[j].angle = units[i].angle;
                        draw(mapUnits[j].textures[0],mapUnits[j].x,mapUnits[j].y,mapUnits[j].angle);
                    }
             }
             
             
            
              
              
            },
            error : function(error) {
                alert(error.responseText);
            }
        });
};


    getUnits();
setInterval(getMovingUnits,500);
});

